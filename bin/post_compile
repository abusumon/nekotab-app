#!/usr/bin/env bash
set -euxo pipefail

echo "-----> I'm post-compile hook"
python --version
pwd
ls -la

# Relax Redis SSL during build only
# Temporary flag previously used to bypass Redis TLS verification during setup
# No longer exported by default; prefer using a proper TLS URL (REDIS_TLS_URL)
# Uncomment the next line only for emergency troubleshooting and re-deploy,
# then revert immediately after.
# export INSECURE_REDIS=1

echo "-----> Using root manage.py"
python - <<'PY'
import os, sys, pathlib
print("CWD:", os.getcwd())
print("sys.path[0:3]:", sys.path[:3])
mp = pathlib.Path("manage.py").resolve()
print("MANAGE.PY:", mp)
PY

echo "-----> Django system check (pre-migrate)"
python manage.py check --deploy -v 2 || true

if [ -n "${DATABASE_URL:-}" ]; then
	echo "-----> DATABASE_URL detected: running migrations"
		python manage.py migrate --noinput
	echo "-----> Running dynamic preferences checks"
		python manage.py checkpreferences || true
else
	echo "-----> DATABASE_URL not set at build time; skipping migrations and preference checks (will run at release)"
fi

echo "-----> Running static files compilation"
python manage.py collectstatic --noinput -v 0

echo "-----> Post-compile done"