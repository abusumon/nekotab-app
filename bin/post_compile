#!/usr/bin/env bash
set -euxo pipefail

echo "-----> I'm post-compile hook"
python --version
pwd
ls -la

# Relax Redis SSL during build only
# Temporary flag previously used to bypass Redis TLS verification during setup
# No longer exported by default; prefer using a proper TLS URL (REDIS_TLS_URL)
# Uncomment the next line only for emergency troubleshooting and re-deploy,
# then revert immediately after.
# export INSECURE_REDIS=1

echo "-----> Using tabbycat/manage.py"
python - <<'PY'
import os, sys, pathlib
print("CWD:", os.getcwd())
print("sys.path[0:3]:", sys.path[:3])
mp = pathlib.Path("tabbycat/manage.py").resolve()
print("MANAGE.PY:", mp)
PY

echo "-----> Running database migration"
python ./tabbycat/manage.py migrate --noinput

echo "-----> Running dynamic preferences checks"
python ./tabbycat/manage.py checkpreferences

echo "-----> Running static files compilation"
python ./tabbycat/manage.py collectstatic --noinput -v 0

echo "-----> Post-compile done"