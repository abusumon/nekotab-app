# NekoTab Tenant Stack - Auto-generated
# Tenant: {{ TENANT_SUBDOMAIN }}
# Generated by Control Plane

version: '3.8'

networks:
  traefik-public:
    external: true
  tenant-{{ TENANT_ID }}-internal:
    driver: overlay
    internal: true

volumes:
  tenant-{{ TENANT_ID }}-media:

services:
  web:
    image: {{ REGISTRY_URL }}/nekotab:{{ IMAGE_TAG }}
    command: ["./bin/docker-wait.sh", "--timeout=30", "postgres-master:5432", "--", "./bin/docker-run-honcho.sh"]
    environment:
      - DEBUG=0
      - IN_DOCKER=1
      - USING_NGINX=1
      - SECRET_KEY={{ TENANT_SECRET_KEY }}
      - DATABASE_URL=postgresql://{{ TENANT_DB_USER }}:{{ TENANT_DB_PASSWORD }}@postgres-master:5432/{{ TENANT_DB_NAME }}
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      - REDIS_PREFIX=tenant_{{ TENANT_ID }}_
      - TENANT_ID={{ TENANT_ID }}
      - TENANT_SUBDOMAIN={{ TENANT_SUBDOMAIN }}
      - ALLOWED_HOSTS={{ TENANT_SUBDOMAIN }}.{{ DOMAIN }},{{ TENANT_SUBDOMAIN }}.localhost
      - DEFAULT_FROM_EMAIL=noreply@{{ TENANT_SUBDOMAIN }}.{{ DOMAIN }}
    volumes:
      - tenant-{{ TENANT_ID }}-media:/tcd/media
    networks:
      - traefik-public
      - tenant-{{ TENANT_ID }}-internal
    deploy:
      mode: replicated
      replicas: 1
      resources:
        limits:
          cpus: '{{ TENANT_CPU_LIMIT }}'
          memory: {{ TENANT_MEMORY_LIMIT }}
        reservations:
          cpus: '0.25'
          memory: 256M
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.tenant-{{ TENANT_ID }}.rule=Host(`{{ TENANT_SUBDOMAIN }}.{{ DOMAIN }}`)"
        - "traefik.http.routers.tenant-{{ TENANT_ID }}.entrypoints=websecure"
        - "traefik.http.routers.tenant-{{ TENANT_ID }}.tls.certresolver=letsencrypt"
        - "traefik.http.services.tenant-{{ TENANT_ID }}.loadbalancer.server.port=8000"
        - "traefik.http.middlewares.tenant-{{ TENANT_ID }}-headers.headers.stsSeconds=31536000"
        - "traefik.http.middlewares.tenant-{{ TENANT_ID }}-headers.headers.contentTypeNosniff=true"
        - "traefik.http.middlewares.tenant-{{ TENANT_ID }}-headers.headers.frameDeny=true"
        - "traefik.http.routers.tenant-{{ TENANT_ID }}.middlewares=tenant-{{ TENANT_ID }}-headers"
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  worker:
    image: {{ REGISTRY_URL }}/nekotab:{{ IMAGE_TAG }}
    command: ["./bin/docker-wait.sh", "--timeout=30", "web:8000", "--", "./bin/docker-run-worker.sh"]
    environment:
      - DEBUG=0
      - IN_DOCKER=1
      - SECRET_KEY={{ TENANT_SECRET_KEY }}
      - DATABASE_URL=postgresql://{{ TENANT_DB_USER }}:{{ TENANT_DB_PASSWORD }}@postgres-master:5432/{{ TENANT_DB_NAME }}
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      - REDIS_PREFIX=tenant_{{ TENANT_ID }}_
      - TENANT_ID={{ TENANT_ID }}
    volumes:
      - tenant-{{ TENANT_ID }}-media:/tcd/media
    networks:
      - tenant-{{ TENANT_ID }}-internal
    deploy:
      mode: replicated
      replicas: 1
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
