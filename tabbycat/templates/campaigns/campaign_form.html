{% extends "campaigns/base.html" %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<style>
  .editor-container { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
  @media (max-width: 1200px) { .editor-container { grid-template-columns: 1fr; } }
  
  .html-editor { font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 13px; min-height: 400px; }
  
  .template-picker { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
  .template-card { border: 2px solid var(--nt-border); border-radius: var(--nt-radius); padding: 16px; cursor: pointer; transition: all 0.2s; text-align: center; }
  .template-card:hover { border-color: var(--nt-primary); background: var(--nt-primary-light); }
  .template-card.active { border-color: var(--nt-primary); background: var(--nt-primary-light); }
  .template-icon { font-size: 32px; margin-bottom: 8px; }
  .template-name { font-weight: 600; font-size: 14px; }
  
  .live-preview { border: 1px solid var(--nt-border); border-radius: var(--nt-radius); background: #fff; min-height: 400px; padding: 0; }
  .preview-toolbar { background: var(--nt-bg); padding: 12px 16px; border-bottom: 1px solid var(--nt-border); display: flex; gap: 8px; align-items: center; }
  .preview-dot { width: 10px; height: 10px; border-radius: 50%; }
  .preview-dot.red { background: #fca5a5; }
  .preview-dot.yellow { background: #fcd34d; }
  .preview-dot.green { background: #6ee7b7; }
  .preview-content { padding: 20px; max-height: 500px; overflow-y: auto; }
  
  .info-panel { background: var(--nt-primary-light); border-radius: var(--nt-radius); padding: 16px 20px; margin-bottom: 24px; }
  .info-panel h4 { font-size: 14px; font-weight: 700; margin-bottom: 8px; color: var(--nt-primary); }
  .info-panel p { font-size: 13px; color: var(--nt-text-secondary); margin: 0; }
</style>
{% endblock %}

{% block content %}
<div class="main-header">
  <div>
    <h1 class="page-title">{{ page_title }}</h1>
    <p class="page-subtitle">
      {% if object %}Editing campaign{% else %}Create a new email campaign{% endif %}
    </p>
  </div>
  <a href="{% url 'campaigns:list' %}" class="btn btn-ghost">‚Üê Back to Campaigns</a>
</div>

<div class="info-panel">
  <h4>üìß Campaign will be sent to {{ total_subscribers }} subscribers</h4>
  <p>Your promotional email will be delivered to all users who have signed up with an email address.</p>
</div>

<form method="post" id="campaign-form">
  {% csrf_token %}
  
  <div class="card" style="margin-bottom: 24px;">
    <div class="card-header">
      <h2 class="card-title">Campaign Details</h2>
    </div>
    
    <div class="grid-2">
      <div class="form-group">
        <label class="form-label" for="id_name">Campaign Name *</label>
        {{ form.name }}
        <p class="form-hint">Internal name for your reference only</p>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="id_subject">Email Subject *</label>
        {{ form.subject }}
        <p class="form-hint">This is what recipients will see in their inbox</p>
      </div>
    </div>
    
    <div class="form-group">
      <label class="form-label" for="id_preview_text">Preview Text</label>
      {{ form.preview_text }}
      <p class="form-hint">Short preview text that appears after the subject line in inbox (optional)</p>
    </div>
  </div>
  
  <div class="card" style="margin-bottom: 24px;">
    <div class="card-header">
      <h2 class="card-title">Email Content</h2>
      <div style="display: flex; gap: 8px;">
        <button type="button" class="btn btn-secondary btn-sm" onclick="insertTemplate('basic')">Basic Template</button>
        <button type="button" class="btn btn-secondary btn-sm" onclick="insertTemplate('promo')">Promo Template</button>
        <button type="button" class="btn btn-secondary btn-sm" onclick="insertTemplate('announcement')">Announcement</button>
      </div>
    </div>
    
    <div class="editor-container">
      <div>
        <div class="form-group">
          <label class="form-label" for="id_html_content">HTML Content *</label>
          <textarea id="id_html_content" name="html_content" class="form-control html-editor" oninput="updatePreview()">{{ form.html_content.value|default:'' }}</textarea>
        </div>
      </div>
      
      <div>
        <label class="form-label">Live Preview</label>
        <div class="live-preview">
          <div class="preview-toolbar">
            <div class="preview-dot red"></div>
            <div class="preview-dot yellow"></div>
            <div class="preview-dot green"></div>
            <span style="margin-left: 12px; font-size: 12px; color: var(--nt-text-muted);">Email Preview</span>
          </div>
          <div class="preview-content" id="preview-content">
            <!-- Preview will be injected here -->
          </div>
        </div>
      </div>
    </div>
    
    <div class="form-group" style="margin-top: 24px;">
      <label class="form-label" for="id_plain_text_content">Plain Text Version (Optional)</label>
      {{ form.plain_text_content }}
      <p class="form-hint">If left empty, plain text will be auto-generated from HTML</p>
    </div>
  </div>
  
  <div class="card">
    <div style="display: flex; gap: 12px; justify-content: flex-end;">
      <a href="{% url 'campaigns:list' %}" class="btn btn-ghost">Cancel</a>
      <button type="submit" class="btn btn-primary btn-lg">
        üíæ Save Campaign
      </button>
    </div>
  </div>
</form>

<script>
// Email Templates
const templates = {
  basic: `<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 0; background: #f8fafc; }
    .container { max-width: 600px; margin: 0 auto; background: #ffffff; }
    .header { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); padding: 40px 30px; text-align: center; }
    .header h1 { color: #ffffff; margin: 0; font-size: 28px; font-weight: 700; }
    .content { padding: 40px 30px; }
    .content h2 { color: #0f172a; font-size: 22px; margin-bottom: 16px; }
    .content p { color: #475569; line-height: 1.7; margin-bottom: 16px; }
    .button { display: inline-block; background: #6366f1; color: #ffffff !important; padding: 14px 32px; border-radius: 8px; text-decoration: none; font-weight: 600; margin: 16px 0; }
    .footer { padding: 30px; text-align: center; background: #f1f5f9; color: #64748b; font-size: 13px; }
    .footer a { color: #6366f1; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>NekoTab</h1>
    </div>
    <div class="content">
      <h2>Hello there! üëã</h2>
      <p>We're excited to share some news with you. Your content goes here...</p>
      <p>
        <a href="https://nekotab.app" class="button">Visit NekoTab</a>
      </p>
      <p>Thanks for being part of our community!</p>
      <p>‚Äî The NekoTab Team</p>
    </div>
    <div class="footer">
      <p>¬© 2026 NekoTab. All rights reserved.</p>
      <p><a href="https://nekotab.app">nekotab.app</a></p>
    </div>
  </div>
</body>
</html>`,

  promo: `<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 0; background: #f8fafc; }
    .container { max-width: 600px; margin: 0 auto; background: #ffffff; }
    .hero { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a78bfa 100%); padding: 60px 30px; text-align: center; }
    .hero h1 { color: #ffffff; margin: 0 0 16px; font-size: 36px; font-weight: 800; }
    .hero p { color: rgba(255,255,255,0.9); font-size: 18px; margin: 0; }
    .badge { display: inline-block; background: rgba(255,255,255,0.2); color: #fff; padding: 8px 20px; border-radius: 50px; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 20px; }
    .content { padding: 40px 30px; }
    .feature { display: flex; gap: 16px; margin-bottom: 24px; }
    .feature-icon { width: 48px; height: 48px; background: #eef2ff; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; flex-shrink: 0; }
    .feature h3 { color: #0f172a; font-size: 16px; margin: 0 0 4px; }
    .feature p { color: #64748b; font-size: 14px; margin: 0; line-height: 1.5; }
    .cta { text-align: center; padding: 20px 30px 40px; }
    .button { display: inline-block; background: #6366f1; color: #ffffff !important; padding: 16px 40px; border-radius: 10px; text-decoration: none; font-weight: 700; font-size: 16px; box-shadow: 0 4px 12px rgba(99,102,241,0.3); }
    .footer { padding: 30px; text-align: center; background: #0f172a; color: #94a3b8; font-size: 13px; }
    .footer a { color: #a78bfa; }
  </style>
</head>
<body>
  <div class="container">
    <div class="hero">
      <div class="badge">üéâ Special Announcement</div>
      <h1>Something Big is Coming!</h1>
      <p>We've been working on something amazing for you.</p>
    </div>
    <div class="content">
      <div class="feature">
        <div class="feature-icon">‚ö°</div>
        <div>
          <h3>Feature One</h3>
          <p>Description of this amazing feature goes here.</p>
        </div>
      </div>
      <div class="feature">
        <div class="feature-icon">üéØ</div>
        <div>
          <h3>Feature Two</h3>
          <p>Another great feature that your users will love.</p>
        </div>
      </div>
      <div class="feature">
        <div class="feature-icon">üöÄ</div>
        <div>
          <h3>Feature Three</h3>
          <p>One more incredible feature to highlight.</p>
        </div>
      </div>
    </div>
    <div class="cta">
      <a href="https://nekotab.app" class="button">Get Started Now ‚Üí</a>
    </div>
    <div class="footer">
      <p>¬© 2026 NekoTab ‚Ä¢ <a href="https://nekotab.app">nekotab.app</a></p>
    </div>
  </div>
</body>
</html>`,

  announcement: `<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 40px 20px; background: #f8fafc; }
    .container { max-width: 560px; margin: 0 auto; background: #ffffff; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden; }
    .header { padding: 30px; border-bottom: 1px solid #e2e8f0; }
    .logo { font-size: 20px; font-weight: 800; color: #6366f1; }
    .content { padding: 40px 30px; }
    .content h1 { color: #0f172a; font-size: 26px; margin: 0 0 20px; line-height: 1.3; }
    .content p { color: #475569; line-height: 1.8; margin-bottom: 20px; font-size: 15px; }
    .highlight { background: linear-gradient(135deg, #eef2ff 0%, #faf5ff 100%); border-left: 4px solid #6366f1; padding: 20px; border-radius: 0 12px 12px 0; margin: 24px 0; }
    .highlight p { margin: 0; color: #4338ca; font-weight: 500; }
    .button { display: inline-block; background: #6366f1; color: #ffffff !important; padding: 14px 28px; border-radius: 8px; text-decoration: none; font-weight: 600; }
    .signature { margin-top: 32px; padding-top: 24px; border-top: 1px solid #e2e8f0; }
    .signature p { color: #64748b; font-size: 14px; margin: 0; }
    .signature strong { color: #0f172a; }
    .footer { padding: 24px 30px; background: #f8fafc; text-align: center; font-size: 12px; color: #94a3b8; }
    .footer a { color: #6366f1; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">üê± NekoTab</div>
    </div>
    <div class="content">
      <h1>Important Announcement</h1>
      <p>Hi there,</p>
      <p>We have some important news to share with you regarding NekoTab. Please take a moment to read this message.</p>
      
      <div class="highlight">
        <p>üì¢ Your important announcement or message goes here. Make it impactful!</p>
      </div>
      
      <p>If you have any questions, feel free to reach out to us. We're always here to help!</p>
      
      <p>
        <a href="https://nekotab.app" class="button">Learn More</a>
      </p>
      
      <div class="signature">
        <p><strong>The NekoTab Team</strong></p>
        <p>Building the future of debate tabulation</p>
      </div>
    </div>
    <div class="footer">
      <p>¬© 2026 NekoTab ‚Ä¢ <a href="https://nekotab.app">nekotab.app</a></p>
    </div>
  </div>
</body>
</html>`
};

function insertTemplate(name) {
  if (confirm('This will replace the current content. Continue?')) {
    document.getElementById('id_html_content').value = templates[name];
    updatePreview();
  }
}

function updatePreview() {
  const html = document.getElementById('id_html_content').value;
  const preview = document.getElementById('preview-content');
  
  // Create a sandboxed preview
  const iframe = document.createElement('iframe');
  iframe.style.width = '100%';
  iframe.style.height = '400px';
  iframe.style.border = 'none';
  iframe.sandbox = 'allow-same-origin';
  
  preview.innerHTML = '';
  preview.appendChild(iframe);
  
  const doc = iframe.contentDocument || iframe.contentWindow.document;
  doc.open();
  doc.write(html);
  doc.close();
}

// Initial preview
document.addEventListener('DOMContentLoaded', function() {
  updatePreview();
});
</script>
{% endblock %}
