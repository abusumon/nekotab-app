{% extends "base.html" %}
{% load debate_tags i18n static content_tags %}

{% block noindex %}
  {% if pref.search_engine_indexing == "none" %}
    <meta name="robots" content="noindex">
  {% elif not meets_content_threshold %}
    <meta name="robots" content="noindex, follow">
  {% endif %}
{% endblock %}

{% block extra-head %}
{# Structured Data: Event #}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Event",
  "name": "{{ tournament.name }}",
  "description": "{{ tournament.name }} â€” debate tournament hosted on NekoTab.",
  "url": "{{ canonical_url|default:request.build_absolute_uri }}",
  "organizer": {
    "@type": "Organization",
    "name": "{% if content_block and content_block.host_organization %}{{ content_block.host_organization }}{% else %}{{ tournament.name }}{% endif %}"
  }{% if content_block and content_block.start_date %},
  "startDate": "{{ content_block.start_date|date:'Y-m-d' }}"{% endif %}{% if content_block and content_block.end_date %},
  "endDate": "{{ content_block.end_date|date:'Y-m-d' }}"{% endif %}{% if content_block and content_block.location %},
  "location": {
    "@type": "Place",
    "name": "{{ content_block.location }}"
  }{% endif %}
}
</script>
{% endblock %}

{% block head-title %}<span class="emoji">ğŸ†</span>
{% blocktrans trimmed with tournament=tournament.name %}
    {{ tournament }}
{% endblocktrans %}{% endblock %}

{% block page-title %}
  {% blocktrans trimmed with tournament=tournament.name %}
    {{ tournament }}
  {% endblocktrans %}
{% endblock %}

{% block page-alerts %}
  {% if not pref.team_tab_released and not pref.motion_tab_released and pref.public_draw == 'off' and not pref.public_results and not pref.public_motions and not pref.public_team_standings and not pref.public_breaking_teams and not pref.public_breaking_adjs and not pref.public_participants and not pref.feedback_progress and pref.participant_ballots == 'off' and pref.participant_feedback == 'off' %}
    <div class="alert alert-info">
      <i data-feather="alert-circle"></i>
      {% trans "There is currently no public information available for this tournament." %}
    </div>
  {% endif %}
{% endblock %}

{% block content %}

  {# â”€â”€ Breadcrumbs â”€â”€ #}
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb bg-transparent px-0" itemscope itemtype="https://schema.org/BreadcrumbList">
      <li class="breadcrumb-item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a href="/" itemprop="item"><span itemprop="name">{% trans "Home" %}</span></a>
        <meta itemprop="position" content="1" />
      </li>
      <li class="breadcrumb-item active" aria-current="page" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <span itemprop="name">{{ tournament.short_name|default:tournament.name }}</span>
        <meta itemprop="position" content="2" />
      </li>
    </ol>
  </nav>

  {# â”€â”€ Hero Header â”€â”€ #}
  <div class="card mb-3 border-0 shadow-sm">
    <div class="card-body">
      <div class="d-md-flex justify-content-between align-items-start">
        <div>
          <h1 class="h3 mb-1">ğŸ† {{ tournament.name }}</h1>
          <div class="text-muted mb-2">
            {% if content_block and content_block.host_organization %}
              <span class="mr-3">ğŸ›ï¸ {{ content_block.host_organization }}</span>
            {% endif %}
            {% if content_block and content_block.location %}
              <span class="mr-3">ğŸ“ {{ content_block.location }}</span>
            {% endif %}
            {% if content_block and content_block.format_description %}
              <span class="mr-3">ğŸ¯ {{ content_block.format_description }}</span>
            {% endif %}
          </div>
          {% if content_block and content_block.start_date %}
            <div class="text-muted small">
              ğŸ“…
              {% if content_block.end_date and content_block.start_date != content_block.end_date %}
                {{ content_block.start_date|date:"M j, Y" }} â€” {{ content_block.end_date|date:"M j, Y" }}
              {% else %}
                {{ content_block.start_date|date:"M j, Y" }}
              {% endif %}
            </div>
          {% endif %}
        </div>
        <div class="mt-2 mt-md-0">
          {% if content_block and content_block.status_label %}
            <span class="badge badge-{% if content_block.status_label == 'Completed' %}success{% elif content_block.status_label == 'In Progress' %}primary{% else %}secondary{% endif %} px-3 py-2"
                  style="font-size: 0.85rem;">
              {{ content_block.status_label }}
            </span>
          {% elif tournament.active %}
            <span class="badge badge-primary px-3 py-2" style="font-size: 0.85rem;">{% trans "Active" %}</span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  {# â”€â”€ Summary Cards â”€â”€ #}
  <div class="row mb-3">
    <div class="col-6 col-md-3 mb-2">
      <div class="card text-center border-0 shadow-sm h-100">
        <div class="card-body py-3">
          <div class="h4 mb-0 text-primary">{{ team_count }}</div>
          <small class="text-muted">{% trans "Teams" %}</small>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3 mb-2">
      <div class="card text-center border-0 shadow-sm h-100">
        <div class="card-body py-3">
          <div class="h4 mb-0 text-primary">{{ round_count }}</div>
          <small class="text-muted">{% trans "Rounds" %} {% if completed_round_count %}({{ completed_round_count }} {% trans "done" %}){% endif %}</small>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3 mb-2">
      <div class="card text-center border-0 shadow-sm h-100">
        <div class="card-body py-3">
          <div class="h4 mb-0 text-primary">{{ adj_count }}</div>
          <small class="text-muted">{% trans "Adjudicators" %}</small>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3 mb-2">
      <div class="card text-center border-0 shadow-sm h-100">
        <div class="card-body py-3">
          <div class="h4 mb-0 text-primary">{{ motion_count }}</div>
          <small class="text-muted">{% trans "Motions" %}</small>
        </div>
      </div>
    </div>
  </div>

  {# â”€â”€ Quick navigation CTAs â”€â”€ #}
  <div class="mb-3 d-flex flex-wrap" style="gap: 8px;">
    {% if pref.public_results and tournament.rounds_with_released_results.exists %}
      {% tournamenturl 'results-public-index' as results_url %}
      <a href="{{ results_url }}" class="btn btn-primary btn-sm">ğŸ“Š {% trans "View Results" %}</a>
    {% endif %}
    {% if pref.public_draw != 'off' %}
      {% tournamenturl 'draw-public-current-rounds' as draw_url %}
      <a href="{{ draw_url }}" class="btn btn-outline-primary btn-sm">ğŸ‘ï¸ {% trans "View Draw" %}</a>
    {% endif %}
    {% if pref.public_motions %}
      {% tournamenturl 'motions-public' as motions_url %}
      <a href="{{ motions_url }}" class="btn btn-outline-primary btn-sm">ğŸ“ {% trans "View Motions" %}</a>
    {% endif %}
    {% if pref.public_participants %}
      {% tournamenturl 'participants-public-list' as participants_url %}
      <a href="{{ participants_url }}" class="btn btn-outline-primary btn-sm">ğŸ‘¥ {% trans "Participants" %}</a>
    {% endif %}
    <a href="{% url 'tournament-create' %}" class="btn btn-outline-secondary btn-sm">â• {% trans "Host Your Own" %}</a>
  </div>

  {% if pref.welcome_message %}
    <div class="card mb-3 border-0 shadow-sm">
      <div class="card-body pb-0">
        {{ pref.welcome_message|safe }}
      </div>
    </div>
  {% endif %}

  {# â”€â”€ About This Tournament (editable by owner) â”€â”€ #}
  {% if content_block and content_block.about_text %}
    <div class="card mb-3 border-0 shadow-sm">
      <div class="card-header bg-white border-bottom-0">
        <h2 class="h5 mb-0">ğŸ“– {% trans "About This Tournament" %}</h2>
      </div>
      <div class="card-body pt-0">
        {{ content_block.about_text|linebreaksbr }}
      </div>
    </div>
  {% endif %}

  {# â”€â”€ Contextual Content (deterministic, SEO-friendly) â”€â”€ #}
  <div class="card mb-3 border-0 shadow-sm">
    <div class="card-body">
      {% tournament_context_text tournament content_block %}
    </div>
  </div>

  <div class="row">

    <div class="col-md-8">

      {# â”€â”€ Tournament Links (existing functionality, preserved) â”€â”€ #}

      <div class="list-group mt-2">

        {% if pref.team_tab_released > 0 %}
          {% trans "Team Tab" as text %}
          {% tournamenturl 'standings-public-tab-team' as url %}
          {% include "components/item-action.html" with icon="users" %}
        {% endif %}

        {% if pref.break_category_tabs_released > 0 %}
          {% for category in tournament.break_categories_nongeneral %}
            {% blocktrans asvar text trimmed with category=category.name %}
              {{ category }} Team Tab
            {% endblocktrans %}
            {% tournamenturl 'standings-public-tab-break-category' category=category.slug as url %}
            {% include "components/item-action.html" with icon="users" %}
          {% endfor %}
        {% endif %}

        {% if pref.speaker_tab_released > 0 %}
          {% trans "Speaker Tab" as text %}
          {% tournamenturl 'standings-public-tab-speaker' as url %}
          {% include "components/item-action.html" with icon="user" %}
        {% endif %}

        {% if pref.speaker_category_tabs_released > 0 %}
          {% for category in tournament.speakercategory_set.all %}
            {% if category.public %}
              {% blocktrans asvar text trimmed with category=category.name %}
                {{ category }} Speaker Tab
              {% endblocktrans %}
              {% tournamenturl 'standings-public-tab-speaker-category' category=category.slug as url %}
              {% include "components/item-action.html" with icon="user" %}
            {% endif %}
          {% endfor %}
        {% endif %}

        {% if pref.replies_tab_released > 0 %}
          {% trans "Replies Tab" as text %}
          {% tournamenturl 'standings-public-tab-replies' as url %}
          {% include "components/item-action.html" with icon="corner-up-right" %}
        {% endif %}

        {% if pref.adjudicators_tab_released %}
          {% trans "Adjudicator Tab" as text %}
          {% tournamenturl 'standings-public-adjudicators-tab' as url %}
          {% include "components/item-action.html" with icon="sun" %}
        {% endif %}

        {% if pref.motion_tab_released %}
          {% trans "Motions Tab" as text %}
          {% tournamenturl 'motions-public-statistics' as url %}
          {% include "components/item-action.html" with icon="file-text" %}
        {% endif %}

        {% if public_side_allocations %}
          {% trans "Sides" as text %}
          {% tournamenturl 'draw-public-side-allocations' as url %}
          {% include "components/item-action.html" with icon="shuffle" %}
        {% endif %}

        {% if pref.public_draw == 'current' and not pref.team_tab_released %}
          {% tournamenturl 'draw-public-current-rounds' as url %}
          {% if tournament.public_draws_available %}
            {% if tournament.current_rounds|length == 1 %}
              {% blocktrans trimmed with round=current_round.name asvar draw_for_round_text %}
                Draw for {{ round }}
              {% endblocktrans %}
            {% else %}
              {% trans "Draws for Current Rounds" as draw_for_round_text %}
            {% endif %}
            {% include "components/item-action.html" with icon="eye" text=draw_for_round_text %}
          {% else %}
            {% if tournament.current_rounds|length == 1 %}
              {% blocktrans trimmed with round=current_round.name asvar draw_for_round_text %}
                {{ round }}'s draw has yet to be released
              {% endblocktrans %}
            {% else %}
              {% trans "The draw for the next round has yet to be released" as draw_for_round_text %}
            {% endif %}
            {% include "components/item-info.html" with icon="eye-off" text=draw_for_round_text type="muted" nopad=True %}
          {% endif %}
        {% endif %}

        {% if pref.public_schedule %}
          {% trans "Schedule" as text %}
          {% tournamenturl 'tournament-public-schedule' as url %}
          {% include "components/item-action.html" with icon="clock" %}
        {% endif %}

        {% if pref.public_checkins %}
          {% trans "Check-Ins" as text %}
          {% tournamenturl 'checkins-public-status' as url %}
          {% include "components/item-action.html" with icon="compass" %}
        {% endif %}

        {% if pref.public_results and tournament.rounds_with_released_results.exists %}
          {% trans "Results" as text %}
          {% tournamenturl 'results-public-index' as url %}
          {% include "components/item-action.html" with icon="trending-up" %}
        {% endif %}

        {% if pref.public_motions %}
          {% trans "Motions" as text %}
          {% tournamenturl 'motions-public' as url %}
          {% include "components/item-action.html" with icon="file-text" %}
        {% endif %}

        {% if pref.public_motions and not pref.motion_tab_released and pref.draw_side_allocations == 'manual-ballot' %}
          {% trans "Sides" as text %}
          {% tournamenturl 'draw-public-side-allocations' as url %}
          {% include "components/item-action.html" with icon="shuffle" %}
        {% endif %}

        {% if pref.public_team_standings and current_round.prev and not pref.team_tab_released %}
          {% trans "Team Standings" as text %}
          {% tournamenturl 'standings-public-teams-current' as url %}
          {% include "components/item-action.html" with icon="bar-chart-2" %}
        {% endif %}

        {% if pref.public_breaking_teams %}
          {% for category in tournament.breakcategory_set.all %}
            {% blocktrans trimmed asvar text with category=category.name %}
              {{ category }} Break
            {% endblocktrans %}
            {% tournamenturl 'breakqual-public-teams' category.slug as url %}
            {% include "components/item-action.html" with icon="pie-chart" %}
          {% endfor %}
        {% endif %}

        {% if pref.public_breaking_adjs %}
          {% trans "Breaking Adjudicators" as text %}
          {% tournamenturl 'breakqual-public-adjs' as url %}
          {% include "components/item-action.html" with icon="shield" %}
        {% endif %}

        {% if pref.public_diversity %}
          {% trans "Diversity" as text %}
          {% tournamenturl 'standings-public-diversity' as url %}
          {% include "components/item-action.html" with icon="globe" %}
        {% endif %}

        {% if pref.public_participants %}
          {% trans "Participants" as text %}
          {% tournamenturl 'participants-public-list' as url %}
          {% include "components/item-action.html" with icon="users" %}
        {% endif %}

        {% if pref.public_institutions_list %}
          {% trans "Institutions" as text %}
          {% tournamenturl 'participants-public-institutions-list' as url %}
          {% include "components/item-action.html" with icon="flag" %}
        {% endif %}

        {% if pref.feedback_progress %}
          {% trans "Feedback Progress" as text %}
          {% tournamenturl 'public_feedback_progress' as url %}
          {% include "components/item-action.html" with icon="aperture" %}
        {% endif %}

        {% if pref.participant_ballots == 'public' %}
          {% for round in tournament.current_rounds %}
            {% blocktrans trimmed with round=round.name asvar text %}Enter Ballot for {{round }}{% endblocktrans %}
            {% roundurl 'results-public-ballot-submission-index' as url %}
            {% include "components/item-action.html" with icon="plus-circle" %}
          {% endfor %}
        {% endif %}

        {% if pref.participant_feedback == 'public' %}
          {% trans "Enter Feedback" as text %}
          {% tournamenturl 'adjfeedback-public-add-index' as url %}
          {% include "components/item-action.html" with icon="plus-square" %}
        {% endif %}

        {% if pref.public_draw == 'all-released' %}
          {% for r in tournament.round_set.all %}
            {% if r.draw_status == r.Status.RELEASED %}
              {% blocktrans trimmed asvar text with round=r.name %}
                Draw for {{ round }}
              {% endblocktrans %}
              {% roundurl 'draw-public-for-round' r as url %}
              {% include "components/item-action.html" with icon="eye" %}
            {% endif %}
          {% endfor %}
        {% endif %}

      </div>

      <div class="list-group mt-2">
        {% if pref.institution_registration %}
          {% trans "Register Institution" as text %}
          {% tournamenturl 'reg-create-institution' as url %}
          {% include "components/item-action.html" with icon="home" %}
        {% endif %}

        {% if pref.open_team_registration %}
          {% trans "Register Open Team" as text %}
          {% tournamenturl 'reg-create-team' as url %}
          {% include "components/item-action.html" with icon="users" %}
        {% endif %}

        {% if pref.open_adj_registration %}
          {% trans "Register Open Adjudicator" as text %}
          {% tournamenturl 'reg-create-adjudicator' as url %}
          {% include "components/item-action.html" with icon="columns" %}
        {% endif %}
      </div>

      {% if pref.tournament_staff %}
        <div class="card mt-3 border-0 shadow-sm">
          <div class="card-header bg-white h6">
            {% trans "Tournament Staff" %}
          </div>
          <div class="card-body">
            {{ pref.tournament_staff|safe }}
          </div>
        </div>
      {% endif %}

    </div>

    {# â”€â”€ Right Sidebar â”€â”€ #}
    <div class="col-md-4">

      {# Related Learn articles (cross-linking) #}
      {% if content_block and content_block.format_description %}
        {% with content_block.format_description|lower as fmt %}
          {% if "bp" in fmt or "british" in fmt %}
            {% show_related_articles "bp" %}
          {% elif "australs" in fmt or "3v3" in fmt %}
            {% show_related_articles "australs" %}
          {% elif "wsdc" in fmt or "world schools" in fmt %}
            {% show_related_articles "wsdc" %}
          {% endif %}
        {% endwith %}
      {% endif %}

      {# Host CTA card #}
      <div class="card mt-3 border-0 shadow-sm">
        <div class="card-body text-center">
          <div style="font-size: 2rem;">ğŸ“‹</div>
          <h6 class="mt-2">{% trans "Host Your Own Tournament" %}</h6>
          <p class="text-muted small">{% trans "NekoTab makes it easy to run debate tournaments with automated draws, smart allocations, digital ballots, and live results." %}</p>
          <a href="{% url 'tournament-create' %}" class="btn btn-primary btn-sm btn-block">{% trans "Create Tournament" %}</a>
        </div>
      </div>

      {# Learn section CTA #}
      <div class="card mt-3 border-0 bg-light">
        <div class="card-body text-center">
          <h6>ğŸ“š {% trans "Learn Debate" %}</h6>
          <p class="text-muted small mb-2">{% trans "Guides on formats, judging, and speaker training." %}</p>
          <a href="/learn/" class="btn btn-outline-primary btn-sm">{% trans "Browse Guides" %}</a>
        </div>
      </div>

    </div>

  </div>


{% endblock content %}
