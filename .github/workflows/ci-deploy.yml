name: CI & Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies (Pipfile)
        run: |
          python -m pip install --upgrade pip
          python -m pip install pipenv
          if [ -f Pipfile ]; then
            pipenv install --deploy --system
          elif [ -f tabbycat-2.10.0/Pipfile ]; then
            export PIPENV_PIPFILE=tabbycat-2.10.0/Pipfile
            pipenv install --deploy --system
          else
            echo "⚠️ No Pipfile found (root or tabbycat-2.10.0). Skipping Python dependencies."
          fi

      - name: Install and build frontend
        run: |
          if [ -f package.json ]; then
            npm ci --silent
            npm run build || echo "⚠️ Build script not found, skipping..."
          else
            echo "⚠️ No package.json found. Skipping frontend build."
          fi

      - name: Deploy to Heroku
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: akhileshns/heroku-deploy@v3.12.12
        with:
          heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
          heroku_app_name: "limitless-peak-31988"
          heroku_email: "abusumon1701@gmail.com"
          usedocker: false

      - name: Notify
        if: ${{ success() }}
        run: |
          echo "✅ Successfully deployed to Heroku app: limitless-peak-31988"
